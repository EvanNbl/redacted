/**
 * Mapping entre noms de pays français (de countries-data.ts) et codes ISO 3166-1 alpha-3
 * utilisés dans le TopoJSON de Natural Earth (world-atlas).
 */
export const FRENCH_TO_ISO3: Record<string, string> = {
  "france": "FRA",
  "afrique du sud": "ZAF",
  "afghanistan": "AFG",
  "albanie": "ALB",
  "algérie": "DZA",
  "allemagne": "DEU",
  "andorre": "AND",
  "angola": "AGO",
  "antigua-et-barbuda": "ATG",
  "arabie saoudite": "SAU",
  "argentine": "ARG",
  "arménie": "ARM",
  "australie": "AUS",
  "autriche": "AUT",
  "azerbaïdjan": "AZE",
  "bahamas": "BHS",
  "bahreïn": "BHR",
  "bangladesh": "BGD",
  "barbade": "BRB",
  "belgique": "BEL",
  "belize": "BLZ",
  "bénin": "BEN",
  "bhoutan": "BTN",
  "biélorussie": "BLR",
  "birmanie": "MMR",
  "bolivie": "BOL",
  "bosnie-herzégovine": "BIH",
  "botswana": "BWA",
  "brésil": "BRA",
  "brunei": "BRN",
  "bulgarie": "BGR",
  "burkina faso": "BFA",
  "burundi": "BDI",
  "cambodge": "KHM",
  "cameroun": "CMR",
  "canada": "CAN",
  "cap-vert": "CPV",
  "chili": "CHL",
  "chine": "CHN",
  "chypre": "CYP",
  "colombie": "COL",
  "comores": "COM",
  "corée du nord": "PRK",
  "corée du sud": "KOR",
  "costa rica": "CRI",
  "côte d'ivoire": "CIV",
  "croatie": "HRV",
  "cuba": "CUB",
  "danemark": "DNK",
  "djibouti": "DJI",
  "dominique": "DMA",
  "égypte": "EGY",
  "émirats arabes unis": "ARE",
  "équateur": "ECU",
  "érythrée": "ERI",
  "espagne": "ESP",
  "eswatini": "SWZ",
  "estonie": "EST",
  "états-unis": "USA",
  "etats-unis": "USA",
  "etats unis": "USA",
  "états unis": "USA",
  "états-unis d'amerique": "USA",
  "etats-unis d'amerique": "USA",
  "états unis d'amerique": "USA",
  "etats unis d'amerique": "USA",
  "états-unis d'amérique": "USA",
  "etats-unis d'amérique": "USA",
  "usa": "USA",
  "united states": "USA",
  "united states of america": "USA",
  "éthiopie": "ETH",
  "fidji": "FJI",
  "finlande": "FIN",
  "gabon": "GAB",
  "gambie": "GMB",
  "géorgie": "GEO",
  "ghana": "GHA",
  "grèce": "GRC",
  "grenade": "GRD",
  "guatemala": "GTM",
  "guinée": "GIN",
  "guinée équatoriale": "GNQ",
  "guinée-bissau": "GNB",
  "guyana": "GUY",
  "haïti": "HTI",
  "honduras": "HND",
  "hongrie": "HUN",
  "inde": "IND",
  "indonésie": "IDN",
  "irak": "IRQ",
  "iran": "IRN",
  "irlande": "IRL",
  "islande": "ISL",
  "israël": "ISR",
  "italie": "ITA",
  "jamaïque": "JAM",
  "japon": "JPN",
  "jordanie": "JOR",
  "kazakhstan": "KAZ",
  "kenya": "KEN",
  "kirghizistan": "KGZ",
  "koweït": "KWT",
  "laos": "LAO",
  "lesotho": "LSO",
  "lettonie": "LVA",
  "liban": "LBN",
  "liberia": "LBR",
  "libye": "LBY",
  "liechtenstein": "LIE",
  "lituanie": "LTU",
  "luxembourg": "LUX",
  "macédoine": "MKD",
  "madagascar": "MDG",
  "malaisie": "MYS",
  "malawi": "MWI",
  "maldives": "MDV",
  "mali": "MLI",
  "malte": "MLT",
  "maroc": "MAR",
  "maurice": "MUS",
  "mauritanie": "MRT",
  "mexique": "MEX",
  "moldavie": "MDA",
  "monaco": "MCO",
  "mongolie": "MNG",
  "monténégro": "MNE",
  "mozambique": "MOZ",
  "namibie": "NAM",
  "népal": "NPL",
  "nicaragua": "NIC",
  "niger": "NER",
  "nigeria": "NGA",
  "norvège": "NOR",
  "nouvelle-zélande": "NZL",
  "oman": "OMN",
  "ouganda": "UGA",
  "ouzbékistan": "UZB",
  "pakistan": "PAK",
  "palestine": "PSE",
  "panama": "PAN",
  "papouasie-nouvelle-guinée": "PNG",
  "paraguay": "PRY",
  "pays-bas": "NLD",
  "pérou": "PER",
  "philippines": "PHL",
  "pologne": "POL",
  "portugal": "PRT",
  "qatar": "QAT",
  "république centrafricaine": "CAF",
  "république démocratique du congo": "COD",
  "république dominicaine": "DOM",
  "république du congo": "COG",
  "république tchèque": "CZE",
  "roumanie": "ROU",
  "royaume-uni": "GBR",
  "russie": "RUS",
  "rwanda": "RWA",
  "salvador": "SLV",
  "sénégal": "SEN",
  "serbie": "SRB",
  "sierra leone": "SLE",
  "singapour": "SGP",
  "slovaquie": "SVK",
  "slovénie": "SVN",
  "somalie": "SOM",
  "soudan": "SDN",
  "soudan du sud": "SSD",
  "sri lanka": "LKA",
  "suède": "SWE",
  "suisse": "CHE",
  "suriname": "SUR",
  "syrie": "SYR",
  "tadjikistan": "TJK",
  "tanzanie": "TZA",
  "tchad": "TCD",
  "thaïlande": "THA",
  "timor oriental": "TLS",
  "togo": "TGO",
  "tunisie": "TUN",
  "turkménistan": "TKM",
  "turquie": "TUR",
  "ukraine": "UKR",
  "uruguay": "URY",
  "venezuela": "VEN",
  "viêt nam": "VNM",
  "yémen": "YEM",
  "zambie": "ZMB",
  "zimbabwe": "ZWE",
};

/** Normalise un nom de pays pour le lookup. */
function normalize(s: string): string {
  return s
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/\p{Diacritic}/gu, "");
}

/** Retourne l'ISO3 pour un nom de pays français. */
export function getISO3(paysName: string): string | undefined {
  if (!paysName || typeof paysName !== "string") return undefined;
  
  const key = normalize(paysName);
  
  // Try exact match first
  if (FRENCH_TO_ISO3[key]) return FRENCH_TO_ISO3[key];
  
  // Try with diacritics removed from the keys too
  for (const [k, v] of Object.entries(FRENCH_TO_ISO3)) {
    if (normalize(k) === key) return v;
  }
  
  // Special handling for common variations
  // Remove common prefixes/suffixes and try again
  let cleaned = key
    .replace(/^les\s+/, "") // Remove "les " prefix
    .replace(/\s+\(.*\)$/, "") // Remove parenthetical content
    .trim();
  
  if (cleaned !== key && FRENCH_TO_ISO3[cleaned]) {
    return FRENCH_TO_ISO3[cleaned];
  }
  
  // Special case for "États-Unis d'Amérique" - try matching just "états-unis"
  if (cleaned.includes("etats-unis") || cleaned.includes("états-unis")) {
    // Try to match "états-unis" or "etats-unis" as base
    const baseMatch = cleaned.match(/(états-unis|etats-unis)/);
    if (baseMatch && FRENCH_TO_ISO3[baseMatch[1]]) {
      return FRENCH_TO_ISO3[baseMatch[1]];
    }
    // Also try without the "d'amerique" part
    const withoutSuffix = cleaned.replace(/\s+d'?amerique.*$/, "").trim();
    if (withoutSuffix !== cleaned && FRENCH_TO_ISO3[withoutSuffix]) {
      return FRENCH_TO_ISO3[withoutSuffix];
    }
  }
  
  return undefined;
}
